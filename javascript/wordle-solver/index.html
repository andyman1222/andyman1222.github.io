<!DOCTYPE HTML>
<html>

<head>
	<meta charset="utf-8">
	<meta content="width=device-width, initial-scale=1" name="viewport" />
	<title>Wordle solver</title>
	<link rel="stylesheet" href="../../style.css" id="style" type="text/css">
	<link rel="icon" href="../../images/fish.png" id="icon" type="image/x-icon">
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
	<script src="../../headerGet.js"></script>
	<script>
		var letterGraph = new Map(); //number -> (char[] -> letter[])
		var wordGraph = new Map() //string -> letter[]
		var inputs = []

		class letter {
			char
			spot
			frequency = 0
			words = new Set()
			constructor(char, spot) {
				this.char = char
				this.spot = spot
			}
		}

		fetch("https://raw.githubusercontent.com/dwyl/english-words/master/words_alpha.txt")
			.then(response => response.text())
			.then(data => {

				tmp = data.split('\r\n')
				tmp.forEach(x => {
					spot = 0
					wordGraph.set(x, new Array())
					x.split('').forEach(y => {
						if (!letterGraph.has(spot))
							letterGraph.set(spot, new Map())
						if (!letterGraph.get(spot).has(y))
							letterGraph.get(spot).set(y, new letter(y, spot))
						letterGraph.get(spot).get(y).words.add(x)

						wordGraph.get(x).push(letterGraph.get(spot).get(y))
						spot++
					})
				})
			})

		function getTotalFrequency(word, lettersToOmit = new Set()) {
			r = 0
			wordGraph.get(word).forEach(function (x) {
				if (!lettersToOmit.has(x))
					r += x.words.size
			}.bind(this))
			return r
		}

		function wordContainsSet(word, set){
			for(i = 0; i < wordGraph.get(word); i++){
				if(set.has(wordGraph.get(word)))
					return true
			}
			return false
		}

		function suggestWord(letterArr, length = -1, exclude = new Set()) {
			return new Promise((resolve) => {
				if (letterArr.length == 0)
					resolve(Array.from(wordGraph.keys()).filter(x => length <= 0 || x.length == length)
						.filter(x => !wordContainsSet(x, exclude))
						.sort((a, b) => getTotalFrequency(b) - getTotalFrequency(a)))
				initList = new Set([...letterArr[0].words].filter(x => length <= 0 || x.length == length))
				.filter(x => !wordContainsSet(x, exclude))
				for (i = 1; i < letterArr.length; i++) {
					initList = new Set([...initList].filter(x => letterArr[i].words.has(x) && !wordContainsSet(x, exclude)))
				}
				resolve([...initList].sort((a, b) => getTotalFrequency(b, new Set(letterArr)) - getTotalFrequency(a, new Set(letterArr))))
			})
		}

		function getLetterArr(i) {
			arr = []
			count = 0
			i.forEach(x => {
				//console.log(x);
				if (count != 0 && !letterGraph.has(count)) {
					throw("There are no words that are that long in English! " + i)
				}
				if ((/[a-zA-Z]/).test(x)) {

					if (!letterGraph.get(count).has(x.toLowerCase())) {
						throw("No such word with that letter combination exists! " + i)
					}
					arr.push(letterGraph.get(count).get(x.toLowerCase()))
					count++
				}
				else if (x === '_')
					count++
			})

			return {array: arr, count: count}
		}

		function getExclSet(i){
			s = new Set()
			i.forEach(x => {
				s = new Set([...s, ...getLetterArr(x.split('')).array])
			})
			return s
		}

		canMake = true
		async function make() {
			if (canMake) {
				canMake = false
				document.getElementById("in").disabled = true
				arr = []
				count = 0
				cont = true
				if (document.getElementById("in").value.length == 0) document.getElementById("words").innerText = "Enter some letters and underscores to begin."
				document.getElementById("words").innerText = "Loading words... The more unknown characters, the more word possibilities, the slower the results"
				document.body.style.cursor = "wait"
				try{
					v = getLetterArr(document.getElementById("in").value.split(''))
					excl = getExclSet(document.getElementById("excl").value.split('\n'))

					suggestWord(v.array, v.count, excl).then((tmp) => {
						setTimeout(() => {
							document.getElementById("words").innerText = ""
							txt = ""
							tmp.forEach(x => { txt += x + "\n" })
							document.getElementById("words").innerText = txt;
						}, 0)
					})
				}
				catch (e) {
					document.getElementById("words").innerText = e
				}
				finally{
					document.body.style.cursor = "default"
					document.getElementById("in").disabled = false
					canMake = true
				}

			}

		}

		async function everyWord() {
			if (canMake) {
				canMake = false
				document.getElementById("in").disabled = true
				document.getElementById("words").innerText = "Loading all words... This will take time"
				document.body.style.cursor = "wait"
				excl = getExclSet(document.getElementById("excl").value.split('\n'))

				suggestWord([],-1, excl).then((tmp) => {
					setTimeout(() => {
						document.getElementById("words").innerText = ""
						txt = ""
						tmp.forEach(x => { txt += x + "\n" })
						document.getElementById("words").innerText = txt;
						document.body.style.cursor = "default"
						document.getElementById("in").disabled = false
						canMake = true
					}, 0)
				})
			}
		}

		//make()
	</script>

</head>

<body>
	<div id='headAndText'>
	</div>
	<div id="centerMenu">
		<h1>Wordle Solver</h1>
		<hr>
		<p>use letters only, or numberscores to indicate unknowns
			<br>Click the button to load results (takes time depending on word complexity)<br>
			Input:<br>
			<input type="text" value="" id="in">
			<br><br>Excluded combinations: (one per line- put any incorrect guess here, replace letters in correct spots with underscore)<br>
			<textarea id="excl"></textarea> <br>
			<button onclick="make()">Load words</button><br>
			<button onclick="everyWord()">Load every English word (warning: may freeze browser for a while)</button><br>
			<br>Possible words (in order by most frequent letters): <br>
			<p id="words">Enter some letters and underscores to begin.</p>
		</p>
	</div>
	</div>

</body>

</html>